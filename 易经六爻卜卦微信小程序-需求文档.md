# 易经六爻卜卦微信小程序 - 需求文档

> **文档版本**: v1.0  
> **创建日期**: 2026-02-12  
> **状态**: 初版规划

---

## 📌 项目概述

### 背景
- 已有 MCP Server 实现易经知识库（先天八卦等基础问答功能）
- 需要扩展至六爻卜卦功能，微信小程序作为前端载体

### 目标
开发微信小程序，实现六爻铜钱卜卦功能，通过陀螺仪/按钮模拟铜钱投掷，将结果发送至 MCP Server 解析并返回卦象解读。

---

## 🏗️ 系统架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   微信小程序    │ ──▶ │   MCP Client    │ ──▶ │  MCP Server     │
│  (陀螺仪/按钮)  │     │  (微信云开发)   │     │ (易经知识库)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                                               │
        ▼                                               ▼
   本地动画渲染                                      返回卦象解读
```

---

## 🎯 核心功能需求

### 1. 铜钱投掷模块
| 方式 | 实现方式 | 优先级 |
|------|----------|--------|
| 陀螺仪 | 调用 `wx.startDeviceMotionListening` 监听摇动 | ⭐⭐⭐ 首选 |
| 按钮 | 点击按钮模拟投掷 | ⭐⭐⭐ 备选 |

### 2. 六爻投掷逻辑
- **投掷次数**: 6次（从下往上）
- **判定规则**:
  - 3枚铜钱
  - 正面=2，背面=1
  - 每次总和: 6(老阴) / 7(少阳) / 8(少阴) / 9(老阳)
- **阴阳转换**: 老阴(6→7)/老阳(9→8) 变爻

### 3. MCP Server 接口
```javascript
// 期望接口设计
POST /mcp/callback
{
  "action": "divination",
  "data": {
    "coins": [6,7,8,9,6,9],  // 6次投掷结果
    "question": "问事业"
  }
}

// 返回
{
  "hexagram": 64,           // 卦象编号
  "name": "未济卦",         // 卦名
  "interpretation": "...",  // 卦辞
  "changed_lines": [1,6],   // 变爻位置
  "analysis": "..."         // 详细解读
}
```

### 4. 前端页面流程
```
首页 ──▶ 诚心问卜 ──▶ 输入问题 ──▶ 投掷铜钱(6次) ──▶ 生成卦象 ──▶ 查看解读
```

---

## 🛠️ 环境准备清单

### 1. 微信小程序注册
| 步骤 | 操作 | 时间 | 费用 |
|------|------|------|------|
| 1.1 | 访问 [微信公众平台](https://mp.weixin.qq.com/) | - | 免费 |
| 1.2 | 选择「小程序」注册 | 5分钟 | 免费 |
| 1.3 | 完成邮箱激活 | 即时 | - |
| 1.4 | 主体信息登记 | - | **300元/年** (个人认证) |

### 2. 个人认证 vs 企业认证
| 类型 | 费用 | 限制 | 建议 |
|------|------|------|------|
| 个人认证 | 300元/年 | 部分 API 受限 | 前期开发测试 |
| 企业认证 | 300元/年 | 无限制 | 正式上线 |

### 3. 开发工具准备
```bash
# 推荐环境
- 微信开发者工具: 最新稳定版
- Node.js: v18+
- 微信小程序 CLI: npm i -g @wechat-miniprogram/cli
```

### 4. 技术栈
```yaml
前端框架:
  - 原生小程序 (推荐)
  - 或: Taro / uni-app (跨平台)

云开发 (可选):
  - 微信云开发 (CloudBase)
  - 用于 MCP Server 代理

动画库:
  - lottie-miniprogram (铜钱旋转动画)
```

---

## 📋 开发计划

### Phase 1: MVP 版本 (1-2周)

#### 1.1 项目初始化
- [ ] 注册小程序账号
- [ ] 完成个人主体认证
- [ ] 开发者工具创建项目
- [ ] 配置 request 合法域名

#### 1.2 核心页面
- [ ] **首页**: 功能入口 + 历史记录
- [ ] **问卜页**: 问题输入 + 陀螺仪/按钮投掷
- [ ] **结果页**: 卦象展示 + MCP 解读

#### 1.3 陀螺仪实现
```javascript
// 核心代码片段
wx.startDeviceMotionListening({
  interval: 'game',
  success(res) {
    // 监听摇动加速度
  }
})

// 摇动判定算法
if (Math.abs(acceleration.x) > threshold) {
  triggerCoinThrow()
}
```

### Phase 2: 后续迭代 (待定)
- [ ] 风水分析功能接入
- [ ] 历史记录持久化
- [ ] 分享功能
- [ ] 更多解读维度

---

## 🔐 API 权限配置

### 微信小程序域名配置
```json
{
  "request合法域名": [
    "https://your-mcp-server.com"
  ],
  "WebSocket域名": [
    "wss://your-mcp-server.com"
  ]
}
```

### MCP Server 暴露方式
| 方案 | 适用场景 | 成本 |
|------|----------|------|
| 公网 IP + 备案域名 | 正式服务 | 域名50元/年 |
| 微信云函数 | 腾讯生态 | 免费额度内 |
| ngrok 内网穿透 | 开发测试 | 免费 |

---

## 💰 成本估算

| 项目 | 费用 | 说明 |
|------|------|------|
| 微信小程序认证 | 300元/年 | 个人/企业同价 |
| 域名费用 | ~50元/年 | 如需备案域名 |
| 服务器(MCP Server) | 按需 | 已有可复用 |
| **总计** | **≈350元/年** | MVP阶段 |

---

## ⚠️ 注意事项

1. **个人小程序限制**:
   - 支付功能受限
   - 部分 API 不可用
   - 建议先以「工具类」定位上架

2. **陀螺仪兼容性**:
   - iOS 需要请求授权 (`DeviceMotionEvent.requestPermission`)
   - 部分 Android 机型传感器精度差异

3. **MCP Server 安全**:
   - 建议添加签名验证
   - 限制调用频率

---

## 📎 附录

### 参考资源
- 微信小程序文档: https://developers.weixin.qq.com/miniprogram/dev/framework/
- DeviceMotion API: https://developers.weixin.qq.com/miniprogram/dev/api/device/motion/wx.startDeviceMotionListening.html
- 六爻基础知识: 百度百科/专业书籍

### 待确认事项
- [ ] MCP Server 接口完整规范
- [ ] 陀螺仪灵敏度参数调整
- [ ] 卦象解读文案来源

---

> 📝 **文档维护**: 后续迭代时更新此文档
 下面为KIMI分析结果



# 易经卜卦微信小程序需求文档

**版本**：v1.0  
**日期**：2026-02-12  
**状态**：初版框架设计

---

## 1. 项目概述

### 1.1 项目背景

#### 1.1.1 现有基础：MCP Server易经知识库

本项目建立在已成熟的 **MCP Server（Model Context Protocol Server）** 基础之上，该服务器已完整部署了基于易经的知识体系，能够深度解析 **先天八卦、后天八卦、六十四卦** 等核心内容。MCP Server作为后端知识引擎，具备回答用户关于卦象含义、爻辞解读、变卦分析等专业问题的能力，为前端微信小程序提供了坚实的知识支撑。

这一现有基础设施极大地降低了项目的技术风险，使得开发团队可以将主要精力集中于前端交互体验的优化与用户界面的精细化设计，而无需从零构建复杂的易经知识库。MCP Server的API接口设计遵循RESTful规范，支持标准的HTTP/HTTPS通信协议，为前后端数据交互提供了标准化的技术路径。根据项目规划，MCP Server将继续作为核心知识服务层，负责处理所有与易经相关的计算、推理与解读任务，确保卜卦结果的专业性与准确性。

#### 1.1.2 目标：开发微信小程序实现六爻卜卦

本项目的核心目标是开发一款基于微信小程序平台的 **六爻卜卦应用**，将传统的铜钱投掷占卜方式数字化、移动化。六爻卜卦作为易经占卜的重要分支，历史悠久，操作规范，通过 **六次投掷形成六个爻位**，组合成本卦与变卦，进而推演吉凶祸福。

微信小程序作为载体，具有 **无需下载安装、即用即走、社交传播便捷** 等显著优势，能够有效降低用户使用门槛，扩大传统文化的传播范围。项目初期聚焦于六爻卜卦的核心功能实现，包括 **摇卦动作模拟、卦象生成、结果解读** 三大环节，力求在移动端还原传统占卜的仪式感与准确性。后续迭代将逐步扩展至风水分析领域，形成完整的传统文化数字化产品矩阵。

### 1.2 产品定位

#### 1.2.1 融合传统文化与现代科技

本产品定位为 **传统文化与现代科技深度融合** 的创新型应用。在技术实现层面，充分利用智能手机的传感器能力（陀螺仪、加速度计等）模拟真实投掷动作，通过算法判定爻象属性，实现"科技赋能传统"的产品理念。在内容呈现层面，严格遵循易经经典文献，确保卦象解读的学术严谨性，同时采用现代化的视觉设计语言，使古老智慧以符合当代审美习惯的方式呈现。

产品将探索 **AR（增强现实）、3D动画** 等前沿技术在占卜场景中的应用可能性，例如通过AR技术将虚拟铜钱叠加于真实环境，增强用户的沉浸感与参与感。这种融合不仅体现在技术层面，更延伸至用户体验设计的方方面面，包括交互流程的简化、信息层级的优化、个性化推荐的引入等，力求在尊重传统的前提下实现产品的现代化转型。

#### 1.2.2 移动端便捷卜卦工具

从用户价值角度，本产品致力于成为用户随身携带的 **"数字占卜师"**，满足随时随地进行卜卦咨询的需求。传统六爻占卜需要准备铜钱、纸笔等工具，流程繁琐，场景受限。移动端解决方案彻底打破了这些限制，用户仅需一部手机即可完成完整占卜流程，极大提升了便利性。

产品将针对移动场景优化交互设计，例如 **支持单手操作、适配多种屏幕尺寸、优化弱网环境下的使用体验** 等。同时，充分利用微信生态的社交属性，支持占卜结果的分享、收藏、讨论，形成用户间的互动社区，增强产品的粘性与传播力。在商业模式层面，可考虑 **免费基础功能与付费深度解读相结合** 的策略，既保证用户的广泛触达，又为专业用户提供高价值服务。

### 1.3 开发阶段规划

| 阶段 | 周期 | 核心任务 | 交付物 |
|:---|:---|:---|:---|
| **第一阶段** | 6-8周 | 基础框架与六爻卜卦功能 | 可运行的MVP产品 |
| **第二阶段** | 8-12周 | 迭代加入风水分析功能 | 完整版v2.0 |

#### 1.3.1 第一阶段：基础框架与六爻卜卦功能

第一阶段为项目奠基期，核心任务是完成技术验证与基础功能开发。具体包括：**微信小程序开发环境搭建、账号认证与权限申请**；**陀螺仪API的技术调研与原型验证**，确定摇卦动作识别的算法方案；**六爻生成逻辑的实现**，包括阴爻（⚋）、阳爻（⚊）、老阴（⚌）、老阳（⚍）的判定规则；**基础UI框架搭建**，完成首页、摇卦页、结果页等核心页面的视觉设计与前端实现；**MCP Server接口对接**，建立稳定的数据通信通道；**按钮随机生成模块作为备选方案同步开发**，确保陀螺仪不可用时的功能完整性。

本阶段结束时，应形成 **可运行的MVP（最小可行产品）**，支持完整的六爻占卜流程，并通过内部测试验证核心功能的稳定性。

#### 1.3.2 第二阶段：迭代加入风水分析功能

第二阶段为功能扩展期，在第一阶段基础上增加风水分析模块。风水分析功能复杂度显著高于六爻卜卦，涉及 **空间定位、方位计算、环境参数采集** 等多个技术环节。具体包括：**基于GPS与电子罗盘的方位定位功能开发**，精确获取用户当前朝向与地理位置；**家具摆放分析算法的设计与实现**，结合传统风水理论（如八宅派、玄空飞星等）建立分析模型；**用户输入界面的优化**，支持房间布局图的绘制或拍照上传；**可视化展示模块的开发**，以直观的方式呈现分析结果（如吉凶方位图、布局建议示意图等）；**与MCP Server的扩展对接**，将风水分析请求纳入知识服务范围。

本阶段还需同步进行第一阶段的优化迭代，根据用户反馈完善六爻卜卦功能的细节体验。

---

## 2. 功能需求

### 2.1 核心功能：六爻摇卦

#### 2.1.1 陀螺仪摇卦（主方案）

##### 2.1.1.1 调用微信小程序陀螺仪API

微信小程序提供了完整的设备传感器API体系，其中 **陀螺仪（Gyroscope）API** 是实现摇卦功能的核心技术基础。根据微信官方文档，陀螺仪API通过 `wx.startGyroscope` 方法启动监听，通过 `wx.onGyroscopeChange` 事件获取设备旋转数据。该API自 **基础库2.3.0版本** 开始支持，目前主流机型均已覆盖，兼容性风险可控。

陀螺仪数据以 **三维角速度（x, y, z轴）** 的形式返回，单位为弧度/秒，采样频率可通过 `interval` 参数配置，支持 `game`（约20ms/次）、`ui`（约60ms/次）、`normal`（约200ms/次）三档。对于摇卦场景，建议采用 `game` 档位以确保动作捕捉的精度，同时需平衡性能消耗与电池续航。

技术实现上，摇卦动作识别需建立 **多维度的判定模型**：

| 判定阶段 | 检测指标 | 阈值建议 |
|:---|:---|:---|
| 投掷启动 | 角速度模长 | > 3 rad/s |
| 空中运动 | 持续高角速度 | 维持100-500ms |
| 落地静止 | 角速度稳定 | 连续10样本 < 0.5 rad/s |
| 超时保护 | 单次最大时长 | 10秒 |

权限管理方面，陀螺仪属于敏感权限，首次调用时会触发系统授权弹窗，需在UI中提前引导用户授权，并优雅处理拒绝授权后的降级方案。

##### 2.1.1.2 模拟真实投掷铜钱动作

真实铜钱投掷包含 **"握持-晃动-释放-落地-静止"** 五个阶段，产品需在数字环境中还原这一完整流程，以增强仪式感与沉浸感：

| 阶段 | 视觉表现 | 触觉反馈 | 音效设计 |
|:---|:---|:---|:---|
| 握持 | 三枚虚拟铜钱3D模型，支持触摸调整 | 轻微震动模拟握持感 | 环境音铺垫 |
| 晃动 | 铜钱随设备运动物理摆动 | `wx.vibrateShort` 持续微震 | 金属碰撞声 |
| 释放 | 检测加速度突变，触发抛出动画 | 单次长震动 | 抛出破空声 |
| 落地 | 虚拟地面弹跳、旋转、摩擦 | 落地瞬间震动 | 清脆回响 |
| 静止 | 正反面朝上定格，结果显示 | 结果确认震动 | 结果提示音 |

视觉设计上，铜钱模型需精细还原历史形制，包括 **外圆内方的经典造型、钱文（如"乾隆通宝"等）、铜锈质感** 等细节。动画效果追求流畅自然，抛出时的抛物线轨迹、落地时的弹跳衰减、旋转时的光影变化均需精心调校。考虑到性能限制，需为 **中低端机型提供简化版动画选项**。

##### 2.1.1.3 通过手机落地朝向判定爻象（阴爻/阳爻/变爻）

爻象判定是摇卦功能的核心算法环节，需将设备的物理朝向映射至易经的符号系统。传统铜钱占卜以 **"字"（正面，有文字）为背、"背"（反面，无文字）为字**，三枚铜钱的组合决定一爻：

| 铜钱组合 | 结果 | 概率 | 符号 |
|:---|:---|:---|:---|
| 三字（三个正面） | **老阴** | 12.5% | ⚋（变爻）|
| 一字两背 | **少阴** | 37.5% | ⚋ |
| 两字一背 | **少阳** | 37.5% | ⚊ |
| 三背（三个反面） | **老阳** | 12.5% | ⚌（变爻）|

技术方案采用 **"朝向分区+时间扰动"** 策略：将设备的三维朝向空间划分为八个卦限，每个卦限对应一种铜钱组合。判定时刻的 **毫秒级时间戳对8取模**，动态调整分区边界，避免固定分区可能带来的统计偏差。变爻概率严格保持25%，确保长期统计符合理论分布。

#### 2.1.2 按钮随机摇卦（备选方案）

##### 2.1.2.1 设备不支持陀螺仪时自动切换

产品应具备 **自动检测与优雅降级** 能力。启动摇卦功能时，首先调用 `wx.getSystemInfo` 或 `wx.canIUse` 检测陀螺仪API的可用性。若检测失败，**自动切换至按钮模式**，并在界面顶部以非侵入式提示（如Toast或横幅）告知用户降级原因。

| 检测场景 | 处理方式 | 用户提示 |
|:---|:---|:---|
| 基础库版本过低（<2.3.0） | 强制按钮模式 | "您的微信版本较新，已切换手动模式" |
| 用户未授权传感器权限 | 引导设置，拒绝则降级 | "需要陀螺仪权限，已切换手动模式" |
| 硬件本身缺失 | 强制按钮模式 | "您的设备不支持摇卦，已切换手动模式" |
| 陀螺仪数据异常 | 尝试3次后降级 | "传感器异常，已切换手动模式" |

##### 2.1.2.2 用户主动选择手动模式

除自动降级外，产品应提供 **主动切换入口**，尊重用户的使用偏好。在摇卦页面的显著位置（右上角设置图标或底部切换栏）放置"切换至手动模式"按钮。用户的模式选择应 **持久化保存**（`wx.setStorageSync`），下次启动时自动恢复。

##### 2.1.2.3 每次点击随机生成单爻结果

按钮模式的核心交互为 **"点击-生成-展示"** 的简洁流程：

```javascript
// 密码学安全随机数生成（推荐）
function generateYao() {
  const array = new Uint8Array(1);
  crypto.getRandomValues(array);
  return array[0] % 4; // 0:老阴, 1:少阴, 2:少阳, 3:老阳
}
```

| 属性 | 规格 |
|:---|:---|
| 随机源 | `crypto.getRandomValues`（基础库2.16.1+）|
| 降级方案 | `Math.random()`（需标注安全级别）|
| 动画时长 | 500-800ms |
| 进度显示 | "第X爻 / 共6爻" |

#### 2.1.3 六爻生成流程

##### 2.1.3.1 六次投掷生成完整卦象

六爻卦象由 **六次投掷自下而上堆叠** 而成，每次投掷产生一爻，六次结果依次为 **初爻、二爻、三爻、四爻、五爻、上爻**。UI中以垂直排列的方式直观呈现生成过程，新爻从底部滑入，已有爻整体上移。

**状态机设计**：

| 状态 | 说明 | 允许转换 |
|:---|:---|:---|
| `IDLE` | 空闲等待 | → `SHAKING` / `BUTTON_WAIT` |
| `SHAKING` | 陀螺仪摇动中 | → `THROWN` |
| `BUTTON_WAIT` | 按钮模式等待点击 | → `THROWN` |
| `THROWN` | 已抛出/点击，动画中 | → `SETTLED` |
| `SETTLED` | 已静止，结果显示 | → `IDLE`（下一爻）/ `COMPLETED` |
| `COMPLETED` | 六爻完成 | → 结果页 |

##### 2.1.3.2 从下至上排列六爻

六爻的排列顺序是易经占卜的严格规范，**初爻为地，上爻为天**，象征事物从微至著的发展过程。UI布局方案：

| 布局类型 | 适用场景 | 视觉特征 |
|:---|:---|:---|
| **垂直列表**（推荐）| 手机竖屏 | 初爻在下、上爻在上，符合现代阅读习惯 |
| **横向展开** | 平板/横屏 | 初爻在右、上爻在左，模拟竹简书写 |
| **圆形卦象** | 特殊主题 | 六爻环绕，中心显示卦名 |

爻象符号设计需兼顾传统韵味与现代清晰度：

| 爻象 | 符号 | 视觉样式 |
|:---|:---|:---|
| 少阳 | ⚊ | 金色长横，渐变光泽 |
| 少阴 | ⚋ | 银色断横，圆润断口 |
| 老阳 | ⚌ | 金色长横+红色光晕圈，闪烁动画 |
| 老阴 | ⚍ | 银色断横+青色叉标记，呼吸动画 |

##### 2.1.3.3 识别本卦与变卦

| 概念 | 定义 | 计算方式 |
|:---|:---|:---|
| **本卦** | 六次投掷的原始结果 | 直接编码为6位二进制（阳=1，阴=0）|
| **变卦** | 变爻阴阳互换后的结果 | 本卦编码 XOR 变爻掩码 |
| **变爻** | 老阴→阳，老阳→阴的位置 | 数组记录，如[0,3]表示初爻、四爻变 |

**卦名查表**：六十四卦每卦对应唯一的六位二进制编码，通过位运算快速查表。例如：
- 乾卦：111111（0x3F）
- 坤卦：000000（0x00）
- 既济卦：101010（0x2A）
- 未济卦：010101（0x15）

### 2.2 结果解读功能

#### 2.2.1 数据传输至MCP Server

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| `hexagram` | string(6) | 本卦编码，如"101010" |
| `changingLines` | number[] | 变爻位置数组，如[0,3] |
| `timestamp` | number | 占卜时间戳（毫秒）|
| `userId` | string? | 用户标识（可选，用于个性化）|
| `mode` | string | "gyroscope" / "button" |

**网络配置**：
- 协议：**HTTPS**
- 超时：10秒
- 重试：失败时最多2次
- 弱网检测：`wx.getNetworkType`，无网时提示"稍后查看"并缓存

#### 2.2.2 接收并展示返回的卦象解读

MCP Server返回的富文本结构：

| 字段 | 内容类型 | 展示方式 |
|:---|:---|:---|
| `title` | 卦名+卦序 | 页面标题，大字突出 |
| `judgment` | 卦辞（原文+译文）| 可折叠经典文献区 |
| `image` | 象传 | 紧随卦辞，注释解读 |
| `lineTexts` | 爻辞数组（6条）| 点击对应爻位展开 |
| `interpretation` | 综合现代解读 | 默认展开，核心内容 |
| `advice` | 行动建议 | 底部固定，按钮化呈现 |

**模式切换**："简洁/详细"满足不同用户需求，初学者看摘要，专业用户查文献出处。

#### 2.2.3 历史记录保存与查看

| 存储方案 | 容量 | 策略 |
|:---|:---|:---|
| 本地缓存（默认）| 10MB | 最近50条，LRU清理 |
| 云端同步（可选）| 无上限 | 需微信登录，跨设备访问 |

历史列表功能：关键词搜索（卦名、日期、备注）、筛选（仅看含变爻）、排序（时间/卦名）。支持 **"再问此事"** 快速占卜，继承部分上下文。

### 2.3 后续迭代：风水分析模块

#### 2.3.1 家具摆放吉凶分析

| 输入方式 | 技术实现 | 适用场景 |
|:---|:---|:---|
| 手动绘制布局 | Canvas画板，拖拽家具图标 | 快速估算 |
| 拍照上传识别 | 图像识别提取关键元素 | 实景分析 |
| 智能家居连接 | IoT设备自动获取位置 | 深度集成 |

**分析维度**：床位朝向与门窗关系（避免"冲煞"）、办公桌"靠山"与"明堂"、沙发聚合分散效应等。

#### 2.3.2 当前方位吉凶判定

| 技术组合 | 功能 | 精度 |
|:---|:---|:---|
| GPS | 粗略地理位置 | 10-100米 |
| Wi-Fi/基站 | 室内定位补充 | 3-50米 |
| 电子罗盘 `wx.startCompass` | 实时朝向 | ±5-15度 |

**UI设计**：指南针式界面，外圈二十四山向，内圈实时评估分数，锁定方向查看详细分析。

#### 2.3.3 环境布局优化建议

| 建议层级 | 实施成本 | 示例 |
|:---|:---|:---|
| 即时调整 | 零成本 | 调整座位朝向、使用屏风遮挡 |
| 短期优化 | 低-中成本 | 小幅移动家具、更换装饰品 |
| 长期规划 | 高成本 | 重大装修改造、房屋置换 |

**3D模拟与AR预览**：用户虚拟拖动家具，实时预览不同方案效果，高级付费功能。

---

## 3. 技术架构

### 3.1 前端架构

#### 3.1.1 微信小程序原生框架

采用 **微信小程序原生开发框架**，最大化利用微信生态能力，确保传感器API的及时支持与最佳性能。

**项目结构**：
```
project/
├── pages/
│   ├── index/          # 首页：功能入口、品牌展示
│   ├── divination/     # 摇卦页：核心交互（陀螺仪+按钮）
│   ├── result/         # 结果页：卦象展示与解读
│   ├── history/        # 历史页：记录列表与管理
│   └── profile/        # 个人页：设置、关于、反馈
├── components/
│   ├── hexagram-display/   # 卦象展示组件
│   ├── coin-animation/     # 铜钱动画组件
│   └── loading-mask/       # 加载遮罩组件
├── utils/
│   ├── random.js       # 随机数生成
│   ├── storage.js      # 本地存储封装
│   └── request.js      # 网络请求封装
├── services/
│   └── mcpService.js   # MCP Server接口
└── app.{js,json,wxss}  # 全局配置
```

状态管理：页面级用 `data`，跨页面用 `getApp().globalData` 或 EventBus，避免Redux复杂度。

#### 3.1.2 陀螺仪数据监听与处理模块

封装 `GyroscopeService` 独立服务类：

| 方法 | 功能 | 注意事项 |
|:---|:---|:---|
| `start()` | 启动监听 | 检查权限，失败降级 |
| `stop()` | 停止监听 | 页面卸载必调用，防内存泄漏 |
| `onShake(callback)` | 订阅晃动事件 | 阈值过滤，防抖处理 |
| `onSettle(callback)` | 订阅静止事件 | 连续稳定判定，输出最终朝向 |

**数字滤波**：滑动平均滤波（简单场景）或卡尔曼滤波（高精度需求），融合加速度计分离重力分量。

#### 3.1.3 随机数生成模块（备选方案）

| 方案 | API | 安全级别 | 兼容性 |
|:---|:---|:---|:---|
| 推荐 | `crypto.getRandomValues` | 密码学安全 | 基础库2.16.1+ |
| 降级 | `Math.random()` | 伪随机，可预测 | 全版本 |

种子管理：时间戳+用户ID+设备信息混合生成，确保同用户同时间重复操作结果不同。

### 3.2 后端交互

#### 3.2.1 MCP Server接口对接

| 端点 | 方法 | 功能 | 状态 |
|:---|:---|:---|:---|
| `/v1/divination/interpret` | POST | 请求卦象解读 | **已可用** |
| `/v1/divination/history` | GET | 获取用户历史记录 | 开发中 |
| `/v1/fengshui/analyze` | POST | 风水分析请求 | **第二阶段** |

认证：API Key模式，生产环境通过云函数/后端代理隐藏。

#### 3.2.2 HTTPS安全通信

- 证书：Let's Encrypt免费证书或商业证书
- 协议：TLS 1.2+，禁用不安全密码套件
- 续期：自动化工具（certbot）
- HSTS：启用，防止降级攻击

#### 3.2.3 跨域问题解决方案（CORS配置）

微信小程序网络请求由微信客户端代理，**理论上无同源策略限制**。但仍需配置CORS应对：开发工具真机调试、H5版扩展、未来跨平台。

| 配置项 | 值 |
|:---|:---|
| `Access-Control-Allow-Origin` | `https://servicewechat.com`, 业务域名 |
| `Access-Control-Allow-Methods` | `GET, POST, OPTIONS` |
| 暴露响应头 | `Content-Type, Authorization, X-Request-ID` |

### 3.3 数据存储

#### 3.3.1 本地缓存：卦象历史记录

| 属性 | 规格 |
|:---|:---|
| API | `wx.setStorage` / `wx.getStorage`（异步）|
| 容量 | 10MB |
| 单条大小 | 约500字节 |
| 理论容量 | 约20,000条 |
| 默认保留 | 最近50条 |
| 清理策略 | LRU，长期未用小程序缓存可能被系统清理 |

**可靠性增强**：重要数据提示用户备份，敏感信息加密存储。

#### 3.3.2 云端同步（可选）

| 方案 | 优势 | 适用阶段 |
|:---|:---|:---|
| 小程序云开发 | 免运维，微信生态深度集成 | 初期快速迭代 |
| 自建后端 | 灵活性高，复杂业务支持 | 用户量增长后 |

---

## 4. 环境准备与账号认证

### 4.1 开发环境搭建

#### 4.1.1 下载安装微信开发者工具

| 项目 | 内容 |
|:---|:---|
| 下载地址 | https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html |
| 支持平台 | Windows、macOS、Linux（Beta）|
| 首次启动 | 微信扫码登录，绑定开发者身份 |

**核心功能**：模拟器（多机型/网络条件）、编辑器（智能提示）、调试器（Network/Storage等面板）、真机调试。

#### 4.1.2 注册微信公众平台账号

流程：访问 [mp.weixin.qq.com](https://mp.weixin.qq.com) → 点击"立即注册" → 选择"小程序"类型 → 填写**未注册过微信生态产品的邮箱** → 设置密码 → 查收激活邮件完成验证。

#### 4.1.3 获取小程序AppID

注册完成后，登录小程序管理后台，"开发"-"开发设置"页面获取 **AppID**（格式如 `wx1234567890abcdef`）。用于创建项目、配置服务器域名、调用微信API。

### 4.2 微信小程序注册流程

| 步骤 | 操作 | 关键提示 |
|:---|:---|:---|
| 4.2.1 | 访问微信公众平台官网 | 使用现代浏览器确保功能完整 |
| 4.2.2 | 选择"小程序"账号类型 | 确认后不可更改，谨慎决策 |
| 4.2.3 | 填写主体信息（个人/企业）| **个人**：姓名、身份证号、手机号、银行卡；**企业**：营业执照、对公账户 |
| 4.2.4 | 邮箱验证与激活 | 链接24小时有效，建议启用邮箱二次验证 |
| 4.2.5 | 完成注册获取AppID | 完善小程序信息（名称、头像、介绍、服务类目）是提交审核前置条件 |

### 4.3 个人认证流程

#### 4.3.1 准备认证资料

| 资料 | 要求 | 用途 |
|:---|:---|:---|
| 个人有效身份证 | 原件、清晰、四角完整、信息可读 | 实名核验与公安库比对 |
| 本人银行卡 | 借记卡，支持快捷支付，预留手机号可用 | 身份真实性验证 |
| 绑定微信的手机号码 | 当前微信绑定，可正常收短信 | 安全验证与通知渠道 |

#### 4.3.2 提交认证申请

| 步骤 | 操作 | 细节 |
|:---|:---|:---|
| 4.3.2.1 | 登录小程序管理后台，"设置-基本设置-微信认证" | 2023年11月起新账号默认未认证，需主动申请 |
| 4.3.2.2 | 上传身份证正反面照片 | 系统自动识别，失败可手动填写 |
| 4.3.2.3 | 填写银行卡信息 | 小额打款验证（10分钟内到账，精确到分回填）或短信验证码 |
| 4.3.2.4 | 完成人脸识别验证 | 微信内活体检测，失败转人工审核 |

#### 4.3.3 审核与开通

| 阶段 | 时长 | 注意事项 |
|:---|:---|:---|
| 等待审核 | 1-3个工作日 | 保持手机畅通，可能接到审核电话（020等广州号码）|
| 审核通过 | 即时 | 获得"个人开发者"认证标识（黄标），解锁完整权限 |
| 认证有效期 | 1年 | 到期前3个月年审提醒，费用30元/年（政策可能调整）|

### 4.4 小程序类目选择

| 类目 | 优势 | 风险 | 策略 |
|:---|:---|:---|:---|
| **主营：工具-占卜/算命** | 直接匹配功能 | 审核严格，可能需补充资质 | 首选，准备传统文化机构合作证明 |
| **备选：文化-传统文化** | 审核相对宽松 | 需弱化预测功能表述 | 次选，调整文案突出文化教育属性 |
| 动态调整 | — | — | 密切关注政策变化，建立与审核团队沟通渠道 |

---

## 5. 开发实施计划

### 5.1 第一阶段：基础框架搭建（2周）

| 任务 | 周期 | 交付标准 |
|:---|:---|:---|
| 5.1.1 项目初始化与页面结构 | 3天 | 可运行的项目骨架，tabBar导航完成 |
| 5.1.2 陀螺仪API接入与测试 | 5天 | 真机测试准确率>95%，误触发率<5% |
| 5.1.3 按钮随机生成模块开发 | 2天 | 与陀螺仪模式数据结构统一 |
| 5.1.4 六爻展示界面实现 | 4天 | 传统与现代结合的视觉设计，支持交互探索 |

### 5.2 第二阶段：核心功能联调（2周）

| 任务 | 周期 | 关键动作 |
|:---|:---|:---|
| 5.2.1 MCP Server接口对接 | 5天 | 确认API规范，Mock数据并行开发 |
| 5.2.2 卦象数据传输与解析 | 4天 | 严格校验机制，异常数据日志记录 |
| 5.2.3 解读结果展示优化 | 5天 | A/B测试验证，用户反馈渠道嵌入 |

### 5.3 第三阶段：测试与发布（2周）

| 任务 | 周期 | 覆盖范围 |
|:---|:---|:---|
| 5.3.1 真机测试（陀螺仪兼容性）| 5天 | iPhone 6+、华为、小米、OPPO、vivo、三星等 |
| 5.3.2 微信官方审核提交 | 3天 | 完善信息、准备说明文档、自查违规内容 |
| 5.3.3 上线发布与运营 | 6天 | 宣传素材、核心指标监测、用户社群运营 |

### 5.4 第四阶段：风水分析迭代（8-12周）

| 任务 | 技术重点 | 预期成果 |
|:---|:---|:---|
| 5.4.1 方位定位功能开发 | GPS+Wi-Fi/基站+电子罗盘融合，卡尔曼滤波 | 实时方位吉凶判定 |
| 5.4.2 家具摆放分析算法 | 八宅派/玄空飞星规则引擎，机器学习优化 | 可计算的吉凶评分系统 |
| 5.4.3 可视化展示优化 | WebGL/Canvas 3D场景，AR预览（高级功能）| 直观的布局优化建议 |

---

## 6. 风险与注意事项

### 6.1 技术风险

| 风险 | 影响 | 应对策略 |
|:---|:---|:---|
| **6.1.1 陀螺仪权限获取失败** | 核心功能不可用 | 三层降级：自动检测切换 → 引导手动开启 → 强制按钮模式 |
| **6.1.2 不同机型兼容性** | 体验不一致，用户流失 | 建立测试矩阵，中低端机型简化动画，持续收集反馈优化 |

### 6.2 合规风险

| 风险 | 说明 | 应对措施 |
|:---|:---|:---|
| **6.2.1 占卜类小程序审核政策** | 平台政策收紧，审核标准变化 | 密切关注官方动态，准备备选类目，建立合规缓冲机制 |
| **6.2.2 内容合规与免责声明** | 避免迷信宣传，明确娱乐属性 | 页面显著位置标注"传统文化体验，结果仅供参考"，用户协议明确责任边界 |

### 6.3 用户体验

| 风险 | 场景 | 解决方案 |
|:---|:---|:---|
| **6.3.1 操作引导与新手教程** | 首次用户不懂六爻流程 | 首次启动强制引导，图文+动画演示，可随时重新查看 |
| **6.3.2 异常状态友好提示** | 网络中断、服务繁忙、结果加载慢 | 骨架屏占位、进度百分比、重试按钮、离线缓存查看 |

---

**文档维护**：本需求文档随项目进展持续更新，重大变更需评审确认。



# 易经卜卦微信小程序需求文档

**版本**：v1.0  
**日期**：2026-02-12  
**状态**：初版框架设计

---

## 1. 项目概述

### 1.1 项目背景

#### 1.1.1 现有基础：MCP Server易经知识库

本项目建立在已成熟的 **MCP Server（Model Context Protocol Server）** 基础之上，该服务器已完整部署了基于易经的知识体系，能够深度解析 **先天八卦、后天八卦、六十四卦** 等核心内容。MCP Server作为后端知识引擎，具备回答用户关于卦象含义、爻辞解读、变卦分析等专业问题的能力，为前端微信小程序提供了坚实的知识支撑。

这一现有基础设施极大地降低了项目的技术风险，使得开发团队可以将主要精力集中于前端交互体验的优化与用户界面的精细化设计，而无需从零构建复杂的易经知识库。MCP Server的API接口设计遵循RESTful规范，支持标准的HTTP/HTTPS通信协议，为前后端数据交互提供了标准化的技术路径。根据项目规划，MCP Server将继续作为核心知识服务层，负责处理所有与易经相关的计算、推理与解读任务，确保卜卦结果的专业性与准确性。

#### 1.1.2 目标：开发微信小程序实现六爻卜卦

本项目的核心目标是开发一款基于微信小程序平台的 **六爻卜卦应用**，将传统的铜钱投掷占卜方式数字化、移动化。六爻卜卦作为易经占卜的重要分支，历史悠久，操作规范，通过 **六次投掷形成六个爻位**，组合成本卦与变卦，进而推演吉凶祸福。

微信小程序作为载体，具有 **无需下载安装、即用即走、社交传播便捷** 等显著优势，能够有效降低用户使用门槛，扩大传统文化的传播范围。项目初期聚焦于六爻卜卦的核心功能实现，包括 **摇卦动作模拟、卦象生成、结果解读** 三大环节，力求在移动端还原传统占卜的仪式感与准确性。后续迭代将逐步扩展至风水分析领域，形成完整的传统文化数字化产品矩阵。

### 1.2 产品定位

#### 1.2.1 融合传统文化与现代科技

本产品定位为 **传统文化与现代科技深度融合** 的创新型应用。在技术实现层面，充分利用智能手机的传感器能力（陀螺仪、加速度计等）模拟真实投掷动作，通过算法判定爻象属性，实现"科技赋能传统"的产品理念。在内容呈现层面，严格遵循易经经典文献，确保卦象解读的学术严谨性，同时采用现代化的视觉设计语言，使古老智慧以符合当代审美习惯的方式呈现。

产品将探索 **AR（增强现实）、3D动画** 等前沿技术在占卜场景中的应用可能性，例如通过AR技术将虚拟铜钱叠加于真实环境，增强用户的沉浸感与参与感。这种融合不仅体现在技术层面，更延伸至用户体验设计的方方面面，包括交互流程的简化、信息层级的优化、个性化推荐的引入等，力求在尊重传统的前提下实现产品的现代化转型。

#### 1.2.2 移动端便捷卜卦工具

从用户价值角度，本产品致力于成为用户随身携带的 **"数字占卜师"**，满足随时随地进行卜卦咨询的需求。传统六爻占卜需要准备铜钱、纸笔等工具，流程繁琐，场景受限。移动端解决方案彻底打破了这些限制，用户仅需一部手机即可完成完整占卜流程，极大提升了便利性。

产品将针对移动场景优化交互设计，例如 **支持单手操作、适配多种屏幕尺寸、优化弱网环境下的使用体验** 等。同时，充分利用微信生态的社交属性，支持占卜结果的分享、收藏、讨论，形成用户间的互动社区，增强产品的粘性与传播力。在商业模式层面，可考虑 **免费基础功能与付费深度解读相结合** 的策略，既保证用户的广泛触达，又为专业用户提供高价值服务。

### 1.3 开发阶段规划

| 阶段 | 周期 | 核心任务 | 交付物 |
|:---|:---|:---|:---|
| **第一阶段** | 6-8周 | 基础框架与六爻卜卦功能 | 可运行的MVP产品 |
| **第二阶段** | 8-12周 | 迭代加入风水分析功能 | 完整版v2.0 |

#### 1.3.1 第一阶段：基础框架与六爻卜卦功能

第一阶段为项目奠基期，核心任务是完成技术验证与基础功能开发。具体包括：**微信小程序开发环境搭建、账号认证与权限申请**；**陀螺仪API的技术调研与原型验证**，确定摇卦动作识别的算法方案；**六爻生成逻辑的实现**，包括阴爻（⚋）、阳爻（⚊）、老阴（⚌）、老阳（⚍）的判定规则；**基础UI框架搭建**，完成首页、摇卦页、结果页等核心页面的视觉设计与前端实现；**MCP Server接口对接**，建立稳定的数据通信通道；**按钮随机生成模块作为备选方案同步开发**，确保陀螺仪不可用时的功能完整性。

本阶段结束时，应形成 **可运行的MVP（最小可行产品）**，支持完整的六爻占卜流程，并通过内部测试验证核心功能的稳定性。

#### 1.3.2 第二阶段：迭代加入风水分析功能

第二阶段为功能扩展期，在第一阶段基础上增加风水分析模块。风水分析功能复杂度显著高于六爻卜卦，涉及 **空间定位、方位计算、环境参数采集** 等多个技术环节。具体包括：**基于GPS与电子罗盘的方位定位功能开发**，精确获取用户当前朝向与地理位置；**家具摆放分析算法的设计与实现**，结合传统风水理论（如八宅派、玄空飞星等）建立分析模型；**用户输入界面的优化**，支持房间布局图的绘制或拍照上传；**可视化展示模块的开发**，以直观的方式呈现分析结果（如吉凶方位图、布局建议示意图等）；**与MCP Server的扩展对接**，将风水分析请求纳入知识服务范围。

本阶段还需同步进行第一阶段的优化迭代，根据用户反馈完善六爻卜卦功能的细节体验。

---

## 2. 功能需求

### 2.1 核心功能：六爻摇卦

#### 2.1.1 陀螺仪摇卦（主方案）

##### 2.1.1.1 调用微信小程序陀螺仪API

微信小程序提供了完整的设备传感器API体系，其中 **陀螺仪（Gyroscope）API** 是实现摇卦功能的核心技术基础。根据微信官方文档，陀螺仪API通过 `wx.startGyroscope` 方法启动监听，通过 `wx.onGyroscopeChange` 事件获取设备旋转数据。该API自 **基础库2.3.0版本** 开始支持，目前主流机型均已覆盖，兼容性风险可控。

陀螺仪数据以 **三维角速度（x, y, z轴）** 的形式返回，单位为弧度/秒，采样频率可通过 `interval` 参数配置，支持 `game`（约20ms/次）、`ui`（约60ms/次）、`normal`（约200ms/次）三档。对于摇卦场景，建议采用 `game` 档位以确保动作捕捉的精度，同时需平衡性能消耗与电池续航。

技术实现上，摇卦动作识别需建立 **多维度的判定模型**：

| 判定阶段 | 检测指标 | 阈值建议 |
|:---|:---|:---|
| 投掷启动 | 角速度模长 | > 3 rad/s |
| 空中运动 | 持续高角速度 | 维持100-500ms |
| 落地静止 | 角速度稳定 | 连续10样本 < 0.5 rad/s |
| 超时保护 | 单次最大时长 | 10秒 |

权限管理方面，陀螺仪属于敏感权限，首次调用时会触发系统授权弹窗，需在UI中提前引导用户授权，并优雅处理拒绝授权后的降级方案。

##### 2.1.1.2 模拟真实投掷铜钱动作

真实铜钱投掷包含 **"握持-晃动-释放-落地-静止"** 五个阶段，产品需在数字环境中还原这一完整流程，以增强仪式感与沉浸感：

| 阶段 | 视觉表现 | 触觉反馈 | 音效设计 |
|:---|:---|:---|:---|
| 握持 | 三枚虚拟铜钱3D模型，支持触摸调整 | 轻微震动模拟握持感 | 环境音铺垫 |
| 晃动 | 铜钱随设备运动物理摆动 | `wx.vibrateShort` 持续微震 | 金属碰撞声 |
| 释放 | 检测加速度突变，触发抛出动画 | 单次长震动 | 抛出破空声 |
| 落地 | 虚拟地面弹跳、旋转、摩擦 | 落地瞬间震动 | 清脆回响 |
| 静止 | 正反面朝上定格，结果显示 | 结果确认震动 | 结果提示音 |

视觉设计上，铜钱模型需精细还原历史形制，包括 **外圆内方的经典造型、钱文（如"乾隆通宝"等）、铜锈质感** 等细节。动画效果追求流畅自然，抛出时的抛物线轨迹、落地时的弹跳衰减、旋转时的光影变化均需精心调校。考虑到性能限制，需为 **中低端机型提供简化版动画选项**。

##### 2.1.1.3 通过手机落地朝向判定爻象（阴爻/阳爻/变爻）

爻象判定是摇卦功能的核心算法环节，需将设备的物理朝向映射至易经的符号系统。传统铜钱占卜以 **"字"（正面，有文字）为背、"背"（反面，无文字）为字**，三枚铜钱的组合决定一爻：

| 铜钱组合 | 结果 | 概率 | 符号 |
|:---|:---|:---|:---|
| 三字（三个正面） | **老阴** | 12.5% | ⚋（变爻）|
| 一字两背 | **少阴** | 37.5% | ⚋ |
| 两字一背 | **少阳** | 37.5% | ⚊ |
| 三背（三个反面） | **老阳** | 12.5% | ⚌（变爻）|

技术方案采用 **"朝向分区+时间扰动"** 策略：将设备的三维朝向空间划分为八个卦限，每个卦限对应一种铜钱组合。判定时刻的 **毫秒级时间戳对8取模**，动态调整分区边界，避免固定分区可能带来的统计偏差。变爻概率严格保持25%，确保长期统计符合理论分布。

#### 2.1.2 按钮随机摇卦（备选方案）

##### 2.1.2.1 设备不支持陀螺仪时自动切换

产品应具备 **自动检测与优雅降级** 能力。启动摇卦功能时，首先调用 `wx.getSystemInfo` 或 `wx.canIUse` 检测陀螺仪API的可用性。若检测失败，**自动切换至按钮模式**，并在界面顶部以非侵入式提示（如Toast或横幅）告知用户降级原因。

| 检测场景 | 处理方式 | 用户提示 |
|:---|:---|:---|
| 基础库版本过低（<2.3.0） | 强制按钮模式 | "您的微信版本较新，已切换手动模式" |
| 用户未授权传感器权限 | 引导设置，拒绝则降级 | "需要陀螺仪权限，已切换手动模式" |
| 硬件本身缺失 | 强制按钮模式 | "您的设备不支持摇卦，已切换手动模式" |
| 陀螺仪数据异常 | 尝试3次后降级 | "传感器异常，已切换手动模式" |

##### 2.1.2.2 用户主动选择手动模式

除自动降级外，产品应提供 **主动切换入口**，尊重用户的使用偏好。在摇卦页面的显著位置（右上角设置图标或底部切换栏）放置"切换至手动模式"按钮。用户的模式选择应 **持久化保存**（`wx.setStorageSync`），下次启动时自动恢复。

##### 2.1.2.3 每次点击随机生成单爻结果

按钮模式的核心交互为 **"点击-生成-展示"** 的简洁流程：

```javascript
// 密码学安全随机数生成（推荐）
function generateYao() {
  const array = new Uint8Array(1);
  crypto.getRandomValues(array);
  return array[0] % 4; // 0:老阴, 1:少阴, 2:少阳, 3:老阳
}
```

| 属性 | 规格 |
|:---|:---|
| 随机源 | `crypto.getRandomValues`（基础库2.16.1+）|
| 降级方案 | `Math.random()`（需标注安全级别）|
| 动画时长 | 500-800ms |
| 进度显示 | "第X爻 / 共6爻" |

#### 2.1.3 六爻生成流程

##### 2.1.3.1 六次投掷生成完整卦象

六爻卦象由 **六次投掷自下而上堆叠** 而成，每次投掷产生一爻，六次结果依次为 **初爻、二爻、三爻、四爻、五爻、上爻**。UI中以垂直排列的方式直观呈现生成过程，新爻从底部滑入，已有爻整体上移。

**状态机设计**：

| 状态 | 说明 | 允许转换 |
|:---|:---|:---|
| `IDLE` | 空闲等待 | → `SHAKING` / `BUTTON_WAIT` |
| `SHAKING` | 陀螺仪摇动中 | → `THROWN` |
| `BUTTON_WAIT` | 按钮模式等待点击 | → `THROWN` |
| `THROWN` | 已抛出/点击，动画中 | → `SETTLED` |
| `SETTLED` | 已静止，结果显示 | → `IDLE`（下一爻）/ `COMPLETED` |
| `COMPLETED` | 六爻完成 | → 结果页 |

##### 2.1.3.2 从下至上排列六爻

六爻的排列顺序是易经占卜的严格规范，**初爻为地，上爻为天**，象征事物从微至著的发展过程。UI布局方案：

| 布局类型 | 适用场景 | 视觉特征 |
|:---|:---|:---|
| **垂直列表**（推荐）| 手机竖屏 | 初爻在下、上爻在上，符合现代阅读习惯 |
| **横向展开** | 平板/横屏 | 初爻在右、上爻在左，模拟竹简书写 |
| **圆形卦象** | 特殊主题 | 六爻环绕，中心显示卦名 |

爻象符号设计需兼顾传统韵味与现代清晰度：

| 爻象 | 符号 | 视觉样式 |
|:---|:---|:---|
| 少阳 | ⚊ | 金色长横，渐变光泽 |
| 少阴 | ⚋ | 银色断横，圆润断口 |
| 老阳 | ⚌ | 金色长横+红色光晕圈，闪烁动画 |
| 老阴 | ⚍ | 银色断横+青色叉标记，呼吸动画 |

##### 2.1.3.3 识别本卦与变卦

| 概念 | 定义 | 计算方式 |
|:---|:---|:---|
| **本卦** | 六次投掷的原始结果 | 直接编码为6位二进制（阳=1，阴=0）|
| **变卦** | 变爻阴阳互换后的结果 | 本卦编码 XOR 变爻掩码 |
| **变爻** | 老阴→阳，老阳→阴的位置 | 数组记录，如[0,3]表示初爻、四爻变 |

**卦名查表**：六十四卦每卦对应唯一的六位二进制编码，通过位运算快速查表。例如：
- 乾卦：111111（0x3F）
- 坤卦：000000（0x00）
- 既济卦：101010（0x2A）
- 未济卦：010101（0x15）

### 2.2 结果解读功能

#### 2.2.1 数据传输至MCP Server

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| `hexagram` | string(6) | 本卦编码，如"101010" |
| `changingLines` | number[] | 变爻位置数组，如[0,3] |
| `timestamp` | number | 占卜时间戳（毫秒）|
| `userId` | string? | 用户标识（可选，用于个性化）|
| `mode` | string | "gyroscope" / "button" |

**网络配置**：
- 协议：**HTTPS**
- 超时：10秒
- 重试：失败时最多2次
- 弱网检测：`wx.getNetworkType`，无网时提示"稍后查看"并缓存

#### 2.2.2 接收并展示返回的卦象解读

MCP Server返回的富文本结构：

| 字段 | 内容类型 | 展示方式 |
|:---|:---|:---|
| `title` | 卦名+卦序 | 页面标题，大字突出 |
| `judgment` | 卦辞（原文+译文）| 可折叠经典文献区 |
| `image` | 象传 | 紧随卦辞，注释解读 |
| `lineTexts` | 爻辞数组（6条）| 点击对应爻位展开 |
| `interpretation` | 综合现代解读 | 默认展开，核心内容 |
| `advice` | 行动建议 | 底部固定，按钮化呈现 |

**模式切换**："简洁/详细"满足不同用户需求，初学者看摘要，专业用户查文献出处。

#### 2.2.3 历史记录保存与查看

| 存储方案 | 容量 | 策略 |
|:---|:---|:---|
| 本地缓存（默认）| 10MB | 最近50条，LRU清理 |
| 云端同步（可选）| 无上限 | 需微信登录，跨设备访问 |

历史列表功能：关键词搜索（卦名、日期、备注）、筛选（仅看含变爻）、排序（时间/卦名）。支持 **"再问此事"** 快速占卜，继承部分上下文。

### 2.3 后续迭代：风水分析模块

#### 2.3.1 家具摆放吉凶分析

| 输入方式 | 技术实现 | 适用场景 |
|:---|:---|:---|
| 手动绘制布局 | Canvas画板，拖拽家具图标 | 快速估算 |
| 拍照上传识别 | 图像识别提取关键元素 | 实景分析 |
| 智能家居连接 | IoT设备自动获取位置 | 深度集成 |

**分析维度**：床位朝向与门窗关系（避免"冲煞"）、办公桌"靠山"与"明堂"、沙发聚合分散效应等。

#### 2.3.2 当前方位吉凶判定

| 技术组合 | 功能 | 精度 |
|:---|:---|:---|
| GPS | 粗略地理位置 | 10-100米 |
| Wi-Fi/基站 | 室内定位补充 | 3-50米 |
| 电子罗盘 `wx.startCompass` | 实时朝向 | ±5-15度 |

**UI设计**：指南针式界面，外圈二十四山向，内圈实时评估分数，锁定方向查看详细分析。

#### 2.3.3 环境布局优化建议

| 建议层级 | 实施成本 | 示例 |
|:---|:---|:---|
| 即时调整 | 零成本 | 调整座位朝向、使用屏风遮挡 |
| 短期优化 | 低-中成本 | 小幅移动家具、更换装饰品 |
| 长期规划 | 高成本 | 重大装修改造、房屋置换 |

**3D模拟与AR预览**：用户虚拟拖动家具，实时预览不同方案效果，高级付费功能。

---

## 3. 技术架构

### 3.1 前端架构

#### 3.1.1 微信小程序原生框架

采用 **微信小程序原生开发框架**，最大化利用微信生态能力，确保传感器API的及时支持与最佳性能。

**项目结构**：
```
project/
├── pages/
│   ├── index/          # 首页：功能入口、品牌展示
│   ├── divination/     # 摇卦页：核心交互（陀螺仪+按钮）
│   ├── result/         # 结果页：卦象展示与解读
│   ├── history/        # 历史页：记录列表与管理
│   └── profile/        # 个人页：设置、关于、反馈
├── components/
│   ├── hexagram-display/   # 卦象展示组件
│   ├── coin-animation/     # 铜钱动画组件
│   └── loading-mask/       # 加载遮罩组件
├── utils/
│   ├── random.js       # 随机数生成
│   ├── storage.js      # 本地存储封装
│   └── request.js      # 网络请求封装
├── services/
│   └── mcpService.js   # MCP Server接口
└── app.{js,json,wxss}  # 全局配置
```

状态管理：页面级用 `data`，跨页面用 `getApp().globalData` 或 EventBus，避免Redux复杂度。

#### 3.1.2 陀螺仪数据监听与处理模块

封装 `GyroscopeService` 独立服务类：

| 方法 | 功能 | 注意事项 |
|:---|:---|:---|
| `start()` | 启动监听 | 检查权限，失败降级 |
| `stop()` | 停止监听 | 页面卸载必调用，防内存泄漏 |
| `onShake(callback)` | 订阅晃动事件 | 阈值过滤，防抖处理 |
| `onSettle(callback)` | 订阅静止事件 | 连续稳定判定，输出最终朝向 |

**数字滤波**：滑动平均滤波（简单场景）或卡尔曼滤波（高精度需求），融合加速度计分离重力分量。

#### 3.1.3 随机数生成模块（备选方案）

| 方案 | API | 安全级别 | 兼容性 |
|:---|:---|:---|:---|
| 推荐 | `crypto.getRandomValues` | 密码学安全 | 基础库2.16.1+ |
| 降级 | `Math.random()` | 伪随机，可预测 | 全版本 |

种子管理：时间戳+用户ID+设备信息混合生成，确保同用户同时间重复操作结果不同。

### 3.2 后端交互

#### 3.2.1 MCP Server接口对接

| 端点 | 方法 | 功能 | 状态 |
|:---|:---|:---|:---|
| `/v1/divination/interpret` | POST | 请求卦象解读 | **已可用** |
| `/v1/divination/history` | GET | 获取用户历史记录 | 开发中 |
| `/v1/fengshui/analyze` | POST | 风水分析请求 | **第二阶段** |

认证：API Key模式，生产环境通过云函数/后端代理隐藏。

#### 3.2.2 HTTPS安全通信

- 证书：Let's Encrypt免费证书或商业证书
- 协议：TLS 1.2+，禁用不安全密码套件
- 续期：自动化工具（certbot）
- HSTS：启用，防止降级攻击

#### 3.2.3 跨域问题解决方案（CORS配置）

微信小程序网络请求由微信客户端代理，**理论上无同源策略限制**。但仍需配置CORS应对：开发工具真机调试、H5版扩展、未来跨平台。

| 配置项 | 值 |
|:---|:---|
| `Access-Control-Allow-Origin` | `https://servicewechat.com`, 业务域名 |
| `Access-Control-Allow-Methods` | `GET, POST, OPTIONS` |
| 暴露响应头 | `Content-Type, Authorization, X-Request-ID` |

### 3.3 数据存储

#### 3.3.1 本地缓存：卦象历史记录

| 属性 | 规格 |
|:---|:---|
| API | `wx.setStorage` / `wx.getStorage`（异步）|
| 容量 | 10MB |
| 单条大小 | 约500字节 |
| 理论容量 | 约20,000条 |
| 默认保留 | 最近50条 |
| 清理策略 | LRU，长期未用小程序缓存可能被系统清理 |

**可靠性增强**：重要数据提示用户备份，敏感信息加密存储。

#### 3.3.2 云端同步（可选）

| 方案 | 优势 | 适用阶段 |
|:---|:---|:---|
| 小程序云开发 | 免运维，微信生态深度集成 | 初期快速迭代 |
| 自建后端 | 灵活性高，复杂业务支持 | 用户量增长后 |

---

## 4. 环境准备与账号认证

### 4.1 开发环境搭建

#### 4.1.1 下载安装微信开发者工具

| 项目 | 内容 |
|:---|:---|
| 下载地址 | https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html |
| 支持平台 | Windows、macOS、Linux（Beta）|
| 首次启动 | 微信扫码登录，绑定开发者身份 |

**核心功能**：模拟器（多机型/网络条件）、编辑器（智能提示）、调试器（Network/Storage等面板）、真机调试。

#### 4.1.2 注册微信公众平台账号

流程：访问 [mp.weixin.qq.com](https://mp.weixin.qq.com) → 点击"立即注册" → 选择"小程序"类型 → 填写**未注册过微信生态产品的邮箱** → 设置密码 → 查收激活邮件完成验证。

#### 4.1.3 获取小程序AppID

注册完成后，登录小程序管理后台，"开发"-"开发设置"页面获取 **AppID**（格式如 `wx1234567890abcdef`）。用于创建项目、配置服务器域名、调用微信API。

### 4.2 微信小程序注册流程

| 步骤 | 操作 | 关键提示 |
|:---|:---|:---|
| 4.2.1 | 访问微信公众平台官网 | 使用现代浏览器确保功能完整 |
| 4.2.2 | 选择"小程序"账号类型 | 确认后不可更改，谨慎决策 |
| 4.2.3 | 填写主体信息（个人/企业）| **个人**：姓名、身份证号、手机号、银行卡；**企业**：营业执照、对公账户 |
| 4.2.4 | 邮箱验证与激活 | 链接24小时有效，建议启用邮箱二次验证 |
| 4.2.5 | 完成注册获取AppID | 完善小程序信息（名称、头像、介绍、服务类目）是提交审核前置条件 |

### 4.3 个人认证流程

#### 4.3.1 准备认证资料

| 资料 | 要求 | 用途 |
|:---|:---|:---|
| 个人有效身份证 | 原件、清晰、四角完整、信息可读 | 实名核验与公安库比对 |
| 本人银行卡 | 借记卡，支持快捷支付，预留手机号可用 | 身份真实性验证 |
| 绑定微信的手机号码 | 当前微信绑定，可正常收短信 | 安全验证与通知渠道 |

#### 4.3.2 提交认证申请

| 步骤 | 操作 | 细节 |
|:---|:---|:---|
| 4.3.2.1 | 登录小程序管理后台，"设置-基本设置-微信认证" | 2023年11月起新账号默认未认证，需主动申请 |
| 4.3.2.2 | 上传身份证正反面照片 | 系统自动识别，失败可手动填写 |
| 4.3.2.3 | 填写银行卡信息 | 小额打款验证（10分钟内到账，精确到分回填）或短信验证码 |
| 4.3.2.4 | 完成人脸识别验证 | 微信内活体检测，失败转人工审核 |

#### 4.3.3 审核与开通

| 阶段 | 时长 | 注意事项 |
|:---|:---|:---|
| 等待审核 | 1-3个工作日 | 保持手机畅通，可能接到审核电话（020等广州号码）|
| 审核通过 | 即时 | 获得"个人开发者"认证标识（黄标），解锁完整权限 |
| 认证有效期 | 1年 | 到期前3个月年审提醒，费用30元/年（政策可能调整）|

### 4.4 小程序类目选择

| 类目 | 优势 | 风险 | 策略 |
|:---|:---|:---|:---|
| **主营：工具-占卜/算命** | 直接匹配功能 | 审核严格，可能需补充资质 | 首选，准备传统文化机构合作证明 |
| **备选：文化-传统文化** | 审核相对宽松 | 需弱化预测功能表述 | 次选，调整文案突出文化教育属性 |
| 动态调整 | — | — | 密切关注政策变化，建立与审核团队沟通渠道 |

---

## 5. 开发实施计划

### 5.1 第一阶段：基础框架搭建（2周）

| 任务 | 周期 | 交付标准 |
|:---|:---|:---|
| 5.1.1 项目初始化与页面结构 | 3天 | 可运行的项目骨架，tabBar导航完成 |
| 5.1.2 陀螺仪API接入与测试 | 5天 | 真机测试准确率>95%，误触发率<5% |
| 5.1.3 按钮随机生成模块开发 | 2天 | 与陀螺仪模式数据结构统一 |
| 5.1.4 六爻展示界面实现 | 4天 | 传统与现代结合的视觉设计，支持交互探索 |

### 5.2 第二阶段：核心功能联调（2周）

| 任务 | 周期 | 关键动作 |
|:---|:---|:---|
| 5.2.1 MCP Server接口对接 | 5天 | 确认API规范，Mock数据并行开发 |
| 5.2.2 卦象数据传输与解析 | 4天 | 严格校验机制，异常数据日志记录 |
| 5.2.3 解读结果展示优化 | 5天 | A/B测试验证，用户反馈渠道嵌入 |

### 5.3 第三阶段：测试与发布（2周）

| 任务 | 周期 | 覆盖范围 |
|:---|:---|:---|
| 5.3.1 真机测试（陀螺仪兼容性）| 5天 | iPhone 6+、华为、小米、OPPO、vivo、三星等 |
| 5.3.2 微信官方审核提交 | 3天 | 完善信息、准备说明文档、自查违规内容 |
| 5.3.3 上线发布与运营 | 6天 | 宣传素材、核心指标监测、用户社群运营 |

### 5.4 第四阶段：风水分析迭代（8-12周）

| 任务 | 技术重点 | 预期成果 |
|:---|:---|:---|
| 5.4.1 方位定位功能开发 | GPS+Wi-Fi/基站+电子罗盘融合，卡尔曼滤波 | 实时方位吉凶判定 |
| 5.4.2 家具摆放分析算法 | 八宅派/玄空飞星规则引擎，机器学习优化 | 可计算的吉凶评分系统 |
| 5.4.3 可视化展示优化 | WebGL/Canvas 3D场景，AR预览（高级功能）| 直观的布局优化建议 |

---

## 6. 风险与注意事项

### 6.1 技术风险

| 风险 | 影响 | 应对策略 |
|:---|:---|:---|
| **6.1.1 陀螺仪权限获取失败** | 核心功能不可用 | 三层降级：自动检测切换 → 引导手动开启 → 强制按钮模式 |
| **6.1.2 不同机型兼容性** | 体验不一致，用户流失 | 建立测试矩阵，中低端机型简化动画，持续收集反馈优化 |

### 6.2 合规风险

| 风险 | 说明 | 应对措施 |
|:---|:---|:---|
| **6.2.1 占卜类小程序审核政策** | 平台政策收紧，审核标准变化 | 密切关注官方动态，准备备选类目，建立合规缓冲机制 |
| **6.2.2 内容合规与免责声明** | 避免迷信宣传，明确娱乐属性 | 页面显著位置标注"传统文化体验，结果仅供参考"，用户协议明确责任边界 |

### 6.3 用户体验

| 风险 | 场景 | 解决方案 |
|:---|:---|:---|
| **6.3.1 操作引导与新手教程** | 首次用户不懂六爻流程 | 首次启动强制引导，图文+动画演示，可随时重新查看 |
| **6.3.2 异常状态友好提示** | 网络中断、服务繁忙、结果加载慢 | 骨架屏占位、进度百分比、重试按钮、离线缓存查看 |

---

**文档维护**：本需求文档随项目进展持续更新，重大变更需评审确认。


